---
description: GCP Secret Manager patterns and best practices.
globs: apps/**/*, infrastructure/**/*
---
# Secret Management Rules

## Secret Storage

- **Provider**: GCP Secret Manager
- **Project**: `vendin-store`
- **Encryption**: Automatic encryption at rest
- **Access**: Via service account IAM roles

## Secret Naming Conventions

- **Control Plane**: `control-plane-db-url`
- **Tenant Databases**: `tenant-{tenantId}-db-url`
- **API Keys**: `{service}-api-key` (e.g., `cloudflare-api-token`)
- **JWT Secrets**: `jwt-secret` (if needed)

## Secret Creation Pattern

```typescript
// Create secret
await gcpSecretManager.createSecret({
  name: `tenant-${tenantId}-db-url`,
  value: databaseConnectionString,
  labels: {
    environment: 'production',
    service: 'tenant-instance',
    tenantId: tenantId
  }
});

// Grant access to service account
await gcpSecretManager.addIamPolicyBinding({
  secret: `tenant-${tenantId}-db-url`,
  member: `serviceAccount:cloud-run-sa@vendin-store.iam.gserviceaccount.com`,
  role: 'roles/secretmanager.secretAccessor'
});
```

## Secret Access in Cloud Run

```yaml
# In Cloud Run deployment
secrets: |
  DATABASE_URL=projects/vendin-store/secrets/tenant-{tenantId}-db-url/versions/latest:ref
```

## Security Best Practices

- **NEVER** log secret values
- **NEVER** commit secrets to version control
- **ALWAYS** use Secret Manager for sensitive data
- **ALWAYS** use least-privilege access
- **ALWAYS** rotate secrets periodically
- **ALWAYS** use versioned secrets (`:latest` or specific version)

## Secret Rotation

- Rotate database passwords periodically
- Update secret versions in Cloud Run deployments
- Maintain old versions for rollback capability
