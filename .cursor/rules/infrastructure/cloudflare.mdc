---
description: Cloudflare for SaaS patterns, Pages deployment, and custom domain management.
globs: apps/storefront/**/*, infrastructure/**/*
---
# Cloudflare Infrastructure Rules

## Subdomain Structure

```
vendin.store                    → Landing page & Signup (root domain)
www.vendin.store                → Redirects to root
control.vendin.store            → Control Plane API (Cloud Run domain mapping)
admin.vendin.store              → Platform admin dashboard (optional)
*.my.vendin.store               → Tenant stores (wildcard)
  ├─ {store}.my.vendin.store → Merchant storefront
  └─ {store}.my.vendin.store/admin → Merchant admin (MedusaJS)
```

## Storefront Deployment (Cloudflare Pages)

- **Platform**: Cloudflare Pages
- **Framework**: Next.js with edge runtime
- **Root Domain**: `vendin.store` (landing page and signup)
- **Wildcard DNS**: `*.my.vendin.store` → Storefront Pages URL

## Cloudflare for SaaS (Custom Domains)

### API Integration Pattern

The Control Plane uses Cloudflare API to manage custom hostnames:

```typescript
// Add custom hostname for tenant
const response = await fetch(
  `https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/custom_hostnames`,
  {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${CLOUDFLARE_API_TOKEN}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      hostname: 'shop.merchant.com',
      ssl: {
        method: 'http',
        type: 'dv',
      },
    }),
  }
);

// Poll for SSL status
await waitForSSLProvisioning(hostnameId);
```

### SSL Provisioning

- SSL certificates automatically provisioned via Cloudflare for SaaS
- Poll status every 30 seconds
- Maximum wait: 24 hours
- Alert if status is "failed"

## Hostname Resolution Pattern

Storefront must resolve tenants from hostname:

```typescript
// Pattern: {store}.my.vendin.store
if (hostname.endsWith('.my.vendin.store')) {
  const storeName = hostname.replace('.my.vendin.store', '');
  const tenant = await findTenantBySubdomain(storeName);
  return tenant;
}

// Pattern: Custom domain
const tenant = await findTenantByCustomDomain(hostname);
return tenant;
```

## Reserved Subdomains

These subdomains are reserved for platform services:
- `www` - Redirects to root
- `control` - Control Plane API
- `admin` - Platform admin dashboard
- `mail`, `ftp` - Infrastructure services

## DNS Configuration

- **Wildcard for tenants**: `*.my` CNAME → Storefront Pages URL
- **Control Plane**: `control` CNAME → `ghs.googlehosted.com` (DNS only)
- **Root domain**: `@` A/CNAME → Storefront Pages URL
