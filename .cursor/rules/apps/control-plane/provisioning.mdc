---
description: Tenant provisioning workflow patterns and best practices.
globs: apps/control-plane/**/*
---
# Tenant Provisioning Patterns

## Provisioning Workflow

The Control Plane orchestrates complete tenant provisioning:

1. **Merchant Signup** → Receive tenant creation request
2. **Create Neon Database** → Via Neon API
3. **Store Database URL** → In GCP Secret Manager
4. **Create Cloud Run Service** → Deploy tenant instance (`tenant-{id}`)
5. **Configure Secrets** → Database URL, Redis namespace, tenant ID
6. **Add Subdomain** → Assign `{store}.my.vendin.store`
7. **Add Custom Hostname** → Via Cloudflare SaaS API (if provided)
8. **Wait for SSL** → Poll Cloudflare API for certificate status
9. **Initialize MedusaJS** → Bootstrap tenant database
10. **Health Check** → Verify tenant instance is responding
11. **Update Status** → Mark tenant as `active`

## Provisioning Time Target

- **Target**: < 2 minutes end-to-end
- **Acceptable**: < 3 minutes
- **Critical**: Must not exceed 3 minutes

## Error Handling and Rollback

**On any failure, rollback all created resources.**

See [docs/examples/provisioning-workflow.ts](../../../docs/examples/provisioning-workflow.ts) for rollback pattern.

## Subdomain Assignment

- **Pattern**: `{store-name}.my.vendin.store`
- **Generation**: Sanitize store name (lowercase, hyphens, no special chars)
- **Uniqueness**: Check against existing subdomains
- **Reserved**: Never use reserved subdomains (see [@references.mdc](../../shared/references.mdc))

## Service Naming

See [@references.mdc](../../shared/references.mdc) for service naming conventions.

## Monitoring

Track provisioning metrics:
- Provisioning time (by step)
- Success rate
- Failure rate by step
- Rollback rate

## References

- **Service naming**: See [@references.mdc](../../shared/references.mdc)
- **Code examples**: See [docs/examples/provisioning-workflow.ts](../../../docs/examples/provisioning-workflow.ts)
- **Database provisioning**: See [@database.mdc](../../infrastructure/database.mdc)
- **Cloud Run deployment**: See [@cloud-run.mdc](../../infrastructure/cloud-run.mdc)
