main:
  params: [args]
  steps:
    - init:
        assign:
          - baseUrl: ${sys.get_env("CONTROL_PLANE_URL")}
          - keep_running: true
          - projectId: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
          - location: ${sys.get_env("GOOGLE_CLOUD_REGION")}

    - processing_loop:
        switch:
          - condition: ${keep_running}
            steps:
              - fetch_batch:
                  call: http.post
                  args:
                    url: ${baseUrl + "/internal/campaigns/" + args.campaignId + "/next-batch"}
                  result: batch_response

              - check_empty:
                  switch:
                    - condition: ${batch_response.body.campaignStatus != "running" and len(batch_response.body.batch) == 0}
                      assign:
                        - keep_running: false
                      next: end_loop
                    - condition: ${len(batch_response.body.batch) == 0}
                      steps:
                        - sleep_wait:
                            call: sys.sleep
                            args:
                              seconds: 30
                        - next: processing_loop

              - process_batch:
                  parallel:
                    shared: [baseUrl, args, projectId, location]
                    for:
                      value: execution
                      in: ${batch_response.body.batch}
                      steps:
                        - run_upgrade:
                            try:
                              call: googleapis.workflowexecutions.v1.projects.locations.workflows.executions.run
                              args:
                                parent: ${"projects/" + projectId + "/locations/" + location + "/workflows/upgrade-tenant"}
                                body:
                                  argument: >-
                                    ${json.encode_to_string({"tenantId": execution.tenantId, "targetImageTag": execution.targetImageTag, "executionId": execution.executionId, "currentImageTag": default(execution.currentImageTag, null)})}
                            except:
                              as: e
                              next: continue

              - next: processing_loop

    - end_loop:
        return: "Campaign Finished"
