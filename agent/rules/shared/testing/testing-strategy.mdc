---
description: Testing patterns, TDD workflows, and coverage requirements.
globs: **/*
---
# Testing Strategy

## Testing Principles

- Write tests for all critical paths
- Maintain tenant isolation in tests
- Test provisioning workflows end-to-end
- Verify scale-to-zero behavior
- Test hostname routing logic

## Test Organization

```
apps/control-plane/tests/
├── unit/              # Unit tests for services, repositories
├── integration/       # Integration tests for API endpoints
└── e2e/              # End-to-end provisioning tests
```

## Coverage Requirements

- **Control Plane**: Minimum 80% coverage
- **Critical paths**: 100% coverage (provisioning, tenant isolation)
- **API endpoints**: All endpoints must have tests

## Testing Patterns

### Tenant Isolation Testing

See [docs/examples/tenant-isolation-test.ts](../../../docs/examples/tenant-isolation-test.ts) for implementation examples.

### Provisioning Performance Testing

See [docs/examples/provisioning-performance-test.ts](../../../docs/examples/provisioning-performance-test.ts) for implementation examples.

## Database Testing with PGLite

### When to Use PGLite

✅ **Use PGLite for:**
- Repository tests (SQL queries, constraints, transactions)
- Integration tests (service + repository workflows)
- API tests (route handlers with database operations)

❌ **Don't Use PGLite for:**
- Service unit tests (mock the repository instead)
- Validator unit tests (no database needed)
- E2E tests (use real infrastructure)

### PGLite Setup Pattern

See [docs/examples/testing-pglite-setup.ts](../../../docs/examples/testing-pglite-setup.ts) for setup pattern.

### Dependency Injection Pattern

Repositories should accept an optional database instance for testing. See [docs/examples/domain-patterns.ts](../../../docs/examples/domain-patterns.ts) for dependency injection pattern.

### UUID Validation in Tests

PGLite enforces PostgreSQL's strict UUID format. Use valid UUIDs in tests:

```typescript
import { randomUUID } from "crypto";

it("should return null when tenant not found", async () => {
  // ✅ Good: Valid UUID
  const found = await repository.findById(randomUUID());
  
  // ❌ Bad: Invalid UUID (will throw PGLite error)
  // const found = await repository.findById("non-existent-id");
});
```

## Test Documentation

See detailed documentation in `docs/test/`:
- [CURRENT_STATE.md](../../../docs/test/CURRENT_STATE.md) - Current implementation with PGLite
- [PLANNED_IMPROVEMENTS.md](../../../docs/test/PLANNED_IMPROVEMENTS.md) - Future test architecture
- [README.md](../../../docs/test/README.md) - Quick reference and commands

## References

- **Project overview**: See [@project-overview.mdc](../project/project-overview.mdc)
- **Code examples**: See [docs/examples/](../../../docs/examples/)
